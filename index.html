<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MATH CLICKER – 無限因数工場</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>body{font-family:sans-serif}</style>
</head>
<body class="bg-slate-100 flex flex-col items-center pt-6 gap-5">

<h1 class="text-2xl font-bold">MATH CLICKER <span class="text-sm font-normal">(v2.1)</span></h1>

<!-- 制限時間ボタン -->
<div class="flex gap-2 items-center text-sm">
  <span class="font-semibold">⏱️ 制限時間:</span>
  <button class="timeBtn px-2 py-1 bg-gray-200 rounded" data-min="1">1分</button>
  <button class="timeBtn px-2 py-1 bg-gray-200 rounded" data-min="3">3分</button>
  <button class="timeBtn px-2 py-1 bg-gray-200 rounded" data-min="5">5分</button>
  <button class="timeBtn px-2 py-1 bg-gray-200 rounded" data-min="10">10分</button>
  <span id="timerDisp" class="ml-3 font-bold"></span>
</div>

<!-- スコア表示 -->
<div id="counter" class="text-4xl font-bold">0</div>
<div id="cps"     class="text-sm mb-4 text-gray-700">自動 +0 / 秒</div>

<!-- クリックボタン -->
<button id="clickBtn"
  class="px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white rounded-lg shadow">
  クリックして数を増やす！
</button>

<!-- 工場リスト -->
<h2 class="text-lg font-semibold mt-8">Unlocked Factories</h2>
<ul id="factoryList" class="space-y-2 text-gray-800"></ul>

<!-- パズルモーダル -->
<div id="puzzleModal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center">
  <div class="bg-white rounded-xl p-6 w-80 shadow-xl">
    <h2 class="font-bold text-lg mb-3">MATH PUZZLE</h2>
    <p id="puzzleQ" class="mb-2"></p>

    <div class="flex gap-2 mb-3">
      <input id="factorInput" type="text"
        class="flex-1 border rounded px-2 py-1" placeholder="因数を入力">
      <button id="addBtn"
        class="px-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded">追加</button>
    </div>

    <div id="factorTags" class="flex flex-wrap gap-2 mb-4"></div>

    <button id="confirmBtn"
      class="w-full px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded">
      確定
    </button>
    <p id="puzzleMsg" class="mt-3 font-bold"></p>
  </div>
</div>

<script>
/* ---------- 状態 ---------- */
let value = 0, cps = 0, clickPower = 1;
let fever = false, gameActive = true;

/* ---------- DOM ---------- */
const counter   = document.getElementById('counter');
const cpsDisp   = document.getElementById('cps');
const clickBtn  = document.getElementById('clickBtn');
const timerDisp = document.getElementById('timerDisp');

/* ---------- 工場データ ---------- */
const factories = [
  {th:30,   name:'×2 ベルトコンベア', puzzle:{q:'24 を素因数分解せよ',   ans:'2×2×2×3'},       gain:  2, clickBoost:1, unlocked:false, shown:false},
  {th:200,  name:'×3 蒸着炉',        puzzle:{q:'90 を素因数分解せよ',   ans:'2×3×3×5'},       gain: 10, clickBoost:1, unlocked:false, shown:false},
  {th:1000, name:'×5 量子粉砕機',    puzzle:{q:'168 を素因数分解せよ',  ans:'2×2×2×3×7'},     gain: 30, clickBoost:2, unlocked:false, shown:false},
  {th:5000, name:'×7 超合金炉',      puzzle:{q:'2310 を素因数分解せよ', ans:'2×3×5×7×11'},    gain:100, clickBoost:3, unlocked:false, shown:false}
];

/* ---------- 表示 ---------- */
function render(){
  counter.textContent = value.toLocaleString();
  cpsDisp.textContent = `自動 +${cps}/秒`;
}

/* ---------- 手動クリック ---------- */
clickBtn.onclick = () => {
  if(!gameActive) return;
  value += clickPower;
  checkUnlocks(); render();
};

/* ---------- 自動加算ループ ---------- */
let loop = setInterval(() => {
  if(!gameActive) return;
  value += cps; checkUnlocks(); render();
}, 1000);

/* ---------- 制限時間ボタン ---------- */
document.querySelectorAll('.timeBtn').forEach(btn => {
  btn.onclick = () => {
    if(!gameActive) return;
    const min = Number(btn.dataset.min);
    startTimer(min * 60);
  };
});

/* ---------- タイマー管理 ---------- */
let timerId = null, endTime = Infinity;
function startTimer(sec){
  endTime = Date.now() + sec * 1000;
  updateTimer();
  timerId = setInterval(updateTimer, 1000);
}
function updateTimer(){
  const diff = endTime - Date.now();
  if(diff <= 0){
    timerDisp.textContent = '00:00';
    stopGame();
  }else{
    const s = Math.floor(diff/1000), m = Math.floor(s/60);
    timerDisp.textContent = `${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
  }
}

/* ---------- ゲーム停止 ---------- */
function stopGame(){
  gameActive = false;
  clearInterval(loop);
  clearInterval(timerId);
  clickBtn.classList.add('opacity-40','cursor-not-allowed');
}

/* ---------- フィーバー ---------- */
function feverMode(sec=6){
  if(fever || !gameActive) return;
  fever = true;
  const oldClick = clickPower, oldCps = cps;
  clickPower *= 3; cps *= 3;
  counter.classList.add('text-red-600','animate-pulse');
  setTimeout(() => {
    clickPower = oldClick; cps = oldCps;
    counter.classList.remove('text-red-600','animate-pulse');
    fever = false;
  }, sec * 1000);
}

/* ---------- パズル関連 ---------- */
const modal   = document.getElementById('puzzleModal');
const qEl     = document.getElementById('puzzleQ');
const tagsDiv = document.getElementById('factorTags');
const inBox   = document.getElementById('factorInput');
const addBtn  = document.getElementById('addBtn');
const confBtn = document.getElementById('confirmBtn');
const msgEl   = document.getElementById('puzzleMsg');

let currentFactory = null, entered = [];

function openPuzzle(f){
  currentFactory = f; entered = []; renderTags();
  msgEl.textContent = ''; qEl.textContent = f.puzzle.q;
  modal.classList.remove('hidden');
}
addBtn.onclick = () => {
  const v = inBox.value.trim();
  if(!/^\d+$/.test(v) || Number(v) < 2){
    alert('2以上の整数を入力してください'); return;
  }
  entered.push(Number(v)); inBox.value = ''; renderTags();
};
function renderTags(){
  tagsDiv.innerHTML = '';
  entered.forEach((n,i) => {
    const tag = document.createElement('span');
    tag.textContent = n; tag.title = 'クリックで削除';
    tag.className = 'px-2 py-0.5 bg-gray-300 rounded text-sm cursor-pointer';
    tag.onclick = () => { entered.splice(i,1); renderTags(); };
    tagsDiv.appendChild(tag);
  });
}
confBtn.onclick = () => {
  if(!entered.length){alert('因数を入力してください');return;}
  const u = [...entered].sort((a,b)=>a-b);
  const a = currentFactory.puzzle.ans.split(/[×x\*\s]/).filter(Boolean).map(Number).sort((a,b)=>a-b);
  if(u.join() === a.join()){
    modal.classList.add('hidden');
    currentFactory.unlocked = true; currentFactory.shown = false;
    cps += currentFactory.gain; clickPower += currentFactory.clickBoost;
    addFactoryToList(currentFactory); feverMode();
  }else{
    msgEl.textContent = '不正解…もう一度！';
  }
};

/* ---------- 工場リスト & アンロック ---------- */
function addFactoryToList(f){
  const li = document.createElement('li');
  li.textContent = `✅ ${f.name}（+${f.gain}/秒, クリック+${f.clickBoost})`;
  document.getElementById('factoryList').appendChild(li);
}
function checkUnlocks(){
  factories.forEach(f => {
    if(!f.unlocked && !f.shown && value >= f.th){
      f.shown = true; openPuzzle(f);
    }
  });
}

/* ---------- 初期描画 ---------- */
render();
</script>
</body>
</html>
